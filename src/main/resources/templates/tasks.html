<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
    />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Tasks | TimeIt</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/header.css" />
    <link rel="stylesheet" href="/css/footer.css" />
    <script th:inline="javascript">
      /*<![CDATA[*/
        let tasksData = [];
        /*[# th:if="${view == 'calendar'}"]*/
          tasksData = [[${tasks}]];
        /*[/]*/
      /*]]>*/
    </script>
    <script src="/js/app.js" defer></script>
    <script th:src="@{/vendor/fullcalendar/index.global.min.js}"></script>
    <link rel="icon" type="image/png" href="/images/logo.png" />
  </head>

  <body>
    <div th:replace="~{fragments/header :: header}"></div>

    <div id="popup" th:if="${errorMessage}" class="popup-error">
      <span th:text="${errorMessage}"></span>
    </div>

    <div
      th:if="${successMessage}"
      class="popup-success"
      style="margin-bottom: 15px"
    >
      <span th:text="${successMessage}"></span>
    </div>

    <div class="container">
      <div class="reminder-float">
        <button
          class="reminder-btn"
          id="reminderBtn"
          aria-label="Upcoming reminders"
        >
          <img src="/images/bell-icon.png" alt="Reminders" />
          <span
            class="reminder-count"
            th:text="${upcomingReminders.size()}"
          ></span>
        </button>

        <span class="reminder-tooltip">Upcoming reminders</span>

        <div class="reminder-panel" id="reminderPanel">
          <table class="reminder-table">
            <thead>
              <tr>
                <th>Task</th>
                <th>Reminder Time</th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="task : ${upcomingReminders}">
                <td th:text="${task.title}"></td>
                <td
                  th:text="${#temporals.format(task.reminderTime, 'dd MMM yyyy, hh:mm a')}"
                ></td>
              </tr>

              <tr th:if="${upcomingReminders.isEmpty()}">
                <td colspan="2">No upcoming reminders</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <section class="task-stats-cards">
        <div class="stat-card overdue">
          <div class="stat-count" th:text="${overdueTasks.size()}">0</div>
          <div class="stat-label">Overdue</div>
        </div>
        <div class="stat-card today">
          <div class="stat-count" th:text="${todayTasks.size()}">0</div>
          <div class="stat-label">Today</div>
        </div>
        <div class="stat-card upcoming">
          <div class="stat-count" th:text="${upcomingTasks.size()}">0</div>
          <div class="stat-label">Upcoming</div>
        </div>
        <div class="stat-card completed">
          <div class="stat-count" th:text="${completedTasks.size()}">0</div>
          <div class="stat-label">Completed</div>
        </div>
        <div class="stat-card pending">
          <div class="stat-count" th:text="${pendingTasks.size()}">0</div>
          <div class="stat-label">Pending</div>
        </div>
        <div class="stat-card all">
          <div class="stat-count" th:text="${allTasks.size()}">0</div>
          <div class="stat-label">All</div>
        </div>
        <div
          class="stat-card progress"
          th:with="
        total=${allTasks.size()},
        completed=${completedTasks.size()},
        percent=${total == 0 ? 0 : (completed * 100 / total)},
        colorClass=${percent < 40 ? 'low' : (percent < 70 ? 'mid' : 'high')}
     "
        >
          <div
            class="progress-ring-wrapper"
            th:title="${total == 0 ? 'No tasks yet' : completed + ' of ' + total + ' tasks completed'}"
          >
            <div class="no-tasks" th:if="${total == 0}">
              <span>—</span>
            </div>
            <div
              class="progress-ring"
              th:if="${total != 0}"
              th:classappend="' ' + ${colorClass}"
              th:style="'--progress:' + ${percent}"
            >
              <span class="progress-text" th:text="${percent + '%'}">0%</span>
            </div>
          </div>

          <div class="stat-label">Progress</div>
        </div>
      </section>

      <form action="/api/tasks" method="get" th:if="${view != 'calendar'}">
        <div>
          <label for="searchInput">Search Title</label>
          <input
            type="text"
            id="searchInput"
            name="keyword"
            th:value="${param.keyword}"
            placeholder="Keyword"
            autocomplete="off"
          />
        </div>
        <div>
          <label for="status">Status</label>
          <select name="status" id="status">
            <option value="">All</option>
            <option
              th:each="s : ${T(enums.TaskStatus).values()}"
              th:value="${s}"
              th:selected="${param.status == s.name()}"
              th:text="${s.label}"
            ></option>
          </select>
        </div>
        <div>
          <label for="priority">Priority</label>
          <select name="priority" id="priority">
            <option value="">All</option>
            <option
              th:each="p : ${T(enums.TaskPriority).values()}"
              th:value="${p}"
              th:selected="${param.priority == p.name()}"
              th:text="${p.label}"
            ></option>
          </select>
        </div>
        <div>
          <label for="sort">Sort By</label>
          <select name="sort" id="sort">
            <option value="">None</option>
            <option value="dueDate" th:selected="${param.sort=='dueDate'}">
              Due Date
            </option>
            <option value="priority" th:selected="${param.sort=='priority'}">
              Priority
            </option>
            <option value="createdAt" th:selected="${param.sort=='createdAt'}">
              Created Date
            </option>
            <option value="title" th:selected="${param.sort=='title'}">
              Title
            </option>
          </select>
        </div>
        <input type="hidden" name="page" value="0" />
        <div th:if="${view == 'table'}">
          <label for="size">Tasks per page</label>
          <select name="size" id="size" onchange="this.form.submit()">
            <option value="5" th:selected="${size == 5}">5</option>
            <option value="10" th:selected="${size == 10}">10</option>
            <option value="15" th:selected="${size == 15}">15</option>
            <option value="25" th:selected="${size == 25}">25</option>
            <option value="9999" th:selected="${size >= 9999}">All</option>
          </select>
        </div>
        <a href="/api/tasks" class="filter-btn clear-btn" title="Clear Filters">
          <img th:src="@{/images/trash.png}" class="icon" alt="Clear" />
          Clear Filters
        </a>

        <input
          type="submit"
          value="Apply Filters"
          class="filter-btn apply-btn"
        />
      </form>

      <div class="view-toggle">
        <a
          th:href="@{/api/tasks(
        page=0,
        size=${size},
        keyword=${param.keyword},
        status=${param.status},
        priority=${param.priority},
        sort=${param.sort},
        view='table'
)}"
          id="tableViewBtn"
          th:classappend="${view == 'table'} ? 'active'"
          class="view-btn"
          >Table View</a
        >

        <a
          th:href="@{/api/tasks(
        page=0,
        size=${size},
        keyword=${param.keyword},
        status=${param.status},
        priority=${param.priority},
        sort=${param.sort},
        view='card'
)}"
          id="cardViewBtn"
          th:classappend="${view == 'card'} ? 'active'"
          class="view-btn"
          >Card View</a
        >

        <a
          th:href="@{/api/tasks(
        view='calendar'
)}"
          id="calendarViewBtn"
          th:classappend="${view == 'calendar'} ? 'active'"
          class="view-btn"
          >Calendar View</a
        >
      </div>

      <table id="tableView" th:if="${view=='table'}" class="table">
        <thead>
          <tr>
            <th>Id</th>
            <th>Name</th>
            <th>Description</th>
            <th>Due Date</th>
            <th>Status</th>
            <th>Priority</th>
            <th>Created At</th>
            <th>Completed At</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr th:if="${#lists.isEmpty(tasks)}">
            <td colspan="9" class="no-tasks-row" style="text-align: center">
              No tasks found.
              <a th:href="@{/api/tasks/add}" class="add-task-link">
                Click to add your first task
              </a>
            </td>
          </tr>
          <tr
            th:each="task : ${tasks}"
            th:class="|task-row priority-${task.priority.label}|"
          >
            <td th:text="${task.id}"></td>
            <td th:text="${task.title}" class="camel-case"></td>
            <td th:text="${task.description}" class="camel-case"></td>
            <td th:text="${task.dueDate}"></td>
            <td>
              <span
                class="status-badge"
                th:classappend="|status-${#strings.toLowerCase(#strings.replace(task.status.label, ' ', '_'))}|"
                th:text="${task.status.label}"
              >
              </span>
            </td>
            <td>
              <span
                class="priority-badge"
                th:classappend="|priority-${task.priority.label}|"
                th:text="${task.priority.label}"
              ></span>
            </td>

            <td th:text="${task.createdAt}"></td>
            <td
              th:text="${task.completedAt != null ? task.completedAt : '--'}"
            ></td>

            <td class="action-cell">
              <div class="action-group-top">
                <a
                  href="javascript:void(0)"
                  class="action-link action-view"
                  onclick="openTaskModal(this)"
                  th:data-id="${task.id}"
                  th:data-title="${task.title}"
                  th:data-desc="${task.description}"
                  th:data-duedate="${task.dueDate}"
                  th:data-status="${task.status}"
                  th:data-priority="${task.priority}"
                  th:data-created="${task.createdAt}"
                  th:data-completed="${task.completedAt}"
                >
                  <img th:src="@{/images/view.png}" class="icon" alt="View" />
                  View
                </a>

                <a
                  th:href="@{|/api/tasks/update/${task.id}|}"
                  class="action-link action-edit"
                >
                  <img th:src="@{/images/pencil.png}" class="icon" alt="Edit" />
                  Edit
                </a>

                <a
                  th:href="@{|/api/tasks/delete/${task.id}|}"
                  class="action-link action-delete"
                  onclick="return confirm('Are you sure you want to delete this task?');"
                >
                  <img
                    th:src="@{/images/trash-2.png}"
                    class="icon"
                    alt="Delete"
                  />
                  Delete
                </a>
              </div>

              <a
                th:if="${task.status.label != 'Completed'}"
                th:href="@{|/api/tasks/markAsDone/${task.id}|}"
                class="action-link action-done"
              >
                <img
                  th:src="@{/images/check-circle.png}"
                  class="icon"
                  alt="check-mark"
                />
                Mark as Done
              </a>

              <span
                th:if="${task.status.label == 'Completed'}"
                class="action-link disabled"
              >
                ✔ Completed
              </span>
            </td>
          </tr>
        </tbody>
      </table>

      <div id="cardView" class="card-view" th:if="${view == 'card'}">
        <div
          th:each="task : ${tasks}"
          th:class="|task-card priority-${task.priority.label}|"
        >
          <div class="card-title camel-case" th:text="${task.title}">
            Task Title
          </div>
          <div
            class="card-description camel-case"
            th:text="${task.description}"
          ></div>

          <div class="card-detail">
            Due Date: <span><strong th:text="${task.dueDate}"></strong></span>
          </div>

          <div class="card-detail">
            Priority:
            <span><strong th:text="${task.priority.label}"></strong></span>
          </div>

          <div class="card-detail">
            Status:
            <span
              class="status-badge"
              th:classappend="|status-${#strings.toLowerCase(#strings.replace(task.status.label, ' ', '_'))}|"
              th:text="${task.status.label}"
            >
            </span>
          </div>

          <div class="card-action-group-top">
            <a
              href="javascript:void(0)"
              class="action-link action-view"
              onclick="openTaskModal(this)"
              th:data-id="${task.id}"
              th:data-title="${task.title}"
              th:data-desc="${task.description}"
              th:data-duedate="${task.dueDate}"
              th:data-status="${task.status.label}"
              th:data-priority="${task.priority.label}"
              th:data-created="${task.createdAt}"
              th:data-completed="${task.completedAt}"
            >
              <img th:src="@{/images/view.png}" class="icon" alt="view-icon" />
              View
            </a>

            <a
              th:href="@{|/api/tasks/update/${task.id}|}"
              class="action-link action-edit"
            >
              <img
                th:src="@{/images/pencil.png}"
                class="icon"
                alt="edit-image"
              />
              Edit
            </a>

            <a
              th:href="@{|/api/tasks/delete/${task.id}|}"
              class="action-link action-delete"
              onclick="return confirm('Are you sure you want to delete this task?');"
            >
              <img
                th:src="@{/images/trash-2.png}"
                class="icon"
                alt="trash-bin"
              />
              Delete
            </a>
          </div>

          <div class="card-actions-bottom">
            <a
              th:if="${task.status.label != 'Completed'}"
              th:href="@{|/api/tasks/markAsDone/${task.id}|}"
              class="action-link action-done"
            >
              <img
                th:src="@{/images/check-circle.png}"
                class="icon"
                alt="check-icon"
              />
              Mark as Done
            </a>

            <span
              th:if="${task.status.label == 'Completed'}"
              class="action-link disabled"
            >
              ✔ Completed
            </span>
          </div>
        </div>
      </div>

      <div
        id="paginationWrapper"
        class="pagination"
        th:if="${totalPages > 1 and view != 'calendar' and size < 9999}"
      >
        <a
          th:if="${currentPage > 0}"
          th:href="@{/api/tasks(
            page=${currentPage - 1},
            size=${size},
            keyword=${param.keyword},
            status=${param.status},
            priority=${param.priority},
            sort=${param.sort},
            view=${param.view}
       )}"
          class="btn"
        >
          Previous
        </a>

        <span>
          Page <span th:text="${currentPage + 1}"></span> of
          <span th:text="${totalPages}"></span>
        </span>

        <a
          th:if="${currentPage < totalPages - 1}"
          th:href="@{/api/tasks(
            page=${currentPage + 1},
            size=${size},
            keyword=${param.keyword},
            status=${param.status},
            priority=${param.priority},
            sort=${param.sort},
            view=${param.view}
       )}"
          class="btn"
        >
          Next
        </a>
      </div>

      <div
        id="calendarView"
        class="calendar-view"
        th:if="${view == 'calendar'}"
      >
        <div id="taskCalendar"></div>
      </div>
    </div>
    <div th:replace="~{fragments/footer :: footer}"></div>

    <div id="taskModal" class="task-modal-overlay">
      <div class="task-card task-modal-card">
        <button class="task-modal-close" onclick="closeTaskModal()">✕</button>

        <h2 class="card-title" id="m-title"></h2>
        <p class="card-description" id="m-desc"></p>

        <div class="modal-meta">
          <div><strong>Task ID</strong> <span id="m-id"></span></div>
          <div><strong>Due Date</strong> <span id="m-due"></span></div>
          <div class="full" style="grid-column: span 2">
            <strong>Date Created</strong> <span id="m-created"></span>
          </div>
        </div>

        <div class="modal-badges">
          <span id="m-status" class="status-badge"></span>
          <span id="m-priority" class="priority-badge"></span>
        </div>
      </div>
    </div>
    <script>
      const reminderBtn = document.getElementById("reminderBtn");
      const reminderPanel = document.getElementById("reminderPanel");

      reminderBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        reminderPanel.classList.toggle("show");
      });

      document.addEventListener("click", (e) => {
        if (
          !reminderPanel.contains(e.target) &&
          !reminderBtn.contains(e.target)
        ) {
          reminderPanel.classList.remove("show");
        }
      });

      const reminderTooltip = document.querySelector(".reminder-tooltip");
      reminderBtn.addEventListener("mouseenter", () => {
        reminderTooltip.classList.add("tooltip-show");
        setTimeout(
          () => reminderTooltip.classList.remove("tooltip-show"),
          1500
        );
      });

      function updateClock() {
        const now = new Date();
        const time = now.toLocaleTimeString();
        document.getElementById("liveClock").textContent = time;
      }

      updateClock();
      setInterval(updateClock, 1000);
    </script>
  </body>
</html>
